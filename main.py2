import streamlit as st
import cv2
import numpy as np
import easyocr
from PIL import Image
import pandas as pd
import ta
import matplotlib.pyplot as plt

st.set_page_config(layout="centered", page_title="ğŸ“ˆ Ù…Ø­Ù„Ù„ ØªØ¯Ø§ÙˆÙ„ Ø°ÙƒÙŠ Ø¨Ø§Ù„ØµÙˆØ±")

st.title("ğŸ¤– ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ø°ÙƒÙŠ Ù…Ù† ØµÙˆØ±Ø© Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ")

uploaded_file = st.file_uploader("ğŸ“¸ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø§Ø±Øª Ø§Ù„Ø¹Ù…Ù„Ø© (PNG Ø£Ùˆ JPG):", type=["png", "jpg", "jpeg"])

@st.cache_data
def extract_text_from_image(image):
    reader = easyocr.Reader(['en'])
    result = reader.readtext(np.array(image))
    return [res[1] for res in result]

def fake_extract_ohlc_from_image(image):
    # Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø¤Ù‚ØªÙ‹Ø§ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨ØªØ­Ù„ÙŠÙ„ Ù…Ù† OpenCV ÙØ¹Ù„ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§)
    data = {
        "open": [0.0002795, 0.00027, 0.000261],
        "high": [0.0002795, 0.000272, 0.000263],
        "low": [0.0002582, 0.000254, 0.000250],
        "close": [0.0002597, 0.000256, 0.000252],
        "volume": [4300000000, 4000000000, 3900000000]
    }
    return pd.DataFrame(data)

def analyze(df):
    df['rsi'] = ta.momentum.RSIIndicator(df['close'], window=3).rsi()
    df['ema'] = ta.trend.EMAIndicator(df['close'], window=3).ema_indicator()
    macd = ta.trend.MACD(df['close'])
    df['macd'] = macd.macd()
    df['macd_signal'] = macd.macd_signal()
    return df.dropna()

def get_signal(df):
    last = df.iloc[-1]
    if last['rsi'] < 30 and last['macd'] > last['macd_signal']:
        return "âœ… Ø´Ø±Ø§Ø¡", "ØªØ´Ø¨Ø¹ Ø¨ÙŠØ¹ÙŠ + ØªÙ‚Ø§Ø·Ø¹ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ÙÙŠ MACD"
    elif last['rsi'] > 70 and last['macd'] < last['macd_signal']:
        return "âŒ Ø¨ÙŠØ¹", "ØªØ´Ø¨Ø¹ Ø´Ø±Ø§Ø¦ÙŠ + ØªÙ‚Ø§Ø·Ø¹ Ø³Ù„Ø¨ÙŠ ÙÙŠ MACD"
    else:
        return "ğŸ” Ø­ÙŠØ§Ø¯", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© Ù…Ø¤ÙƒØ¯Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§"

def trade_levels(df, rr_ratio=2):
    entry = df['close'].iloc[-1]
    sl = df['low'].min() * 0.98
    tp = entry + (entry - sl) * rr_ratio
    rr = (tp - entry) / (entry - sl)
    return entry, sl, tp, rr

if uploaded_file:
    image = Image.open(uploaded_file).convert("RGB")
    st.image(image, caption="ğŸ“· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©", use_column_width=True)

    st.subheader("ğŸ“– Ù†ØµÙˆØµ Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© (OCR):")
    text_lines = extract_text_from_image(image)
    st.code("\n".join(text_lines))

    st.subheader("ğŸ“ˆ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ (ØªØ¬Ø±ÙŠØ¨ÙŠØ©):")
    df = fake_extract_ohlc_from_image(image)
    st.dataframe(df)

    st.subheader("ğŸ“Š ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ:")
    df = analyze(df)
    signal, reason = get_signal(df)
    entry, sl, tp, rr = trade_levels(df)

    st.success(f"ğŸ“Œ Ø§Ù„ØªÙˆØµÙŠØ©: {signal}")
    st.info(f"ğŸ“Œ Ø§Ù„Ø³Ø¨Ø¨: {reason}")
    st.markdown(f"- Entry: `{entry:.8f}`")
    st.markdown(f"- Stop Loss: `{sl:.8f}`")
    st.markdown(f"- Take Profit: `{tp:.8f}`")
    st.markdown(f"- R/R Ratio: `{rr:.2f}`")

    fig, ax = plt.subplots()
    ax.plot(df['close'], label='Ø§Ù„Ø³Ø¹Ø±')
    ax.plot(df['ema'], label='EMA')
    ax.set_title("ğŸ“‰ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ø¹Ø±")
    ax.legend()
    st.pyplot(fig)
    import streamlit as st
import cv2
import numpy as np
import easyocr
from PIL import Image
import pandas as pd
import ta
import matplotlib.pyplot as plt

st.set_page_config(layout="centered", page_title="ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ ØªØ¯Ø§ÙˆÙ„ Ø°ÙƒÙŠ Ù…Ù† ØµÙˆØ±Ø©")

st.title("ğŸ“· ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ø°ÙƒÙŠ Ù…Ù† ØµÙˆØ±Ø© Ø´Ø§Ø±Øª")

uploaded_file = st.file_uploader("Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø§Ø±Øª Ù…Ù† TradingView Ø£Ùˆ Binance", type=["png", "jpg", "jpeg"])

@st.cache_data
def extract_text_from_image(image):
    reader = easyocr.Reader(['en'])
    result = reader.readtext(np.array(image))
    return [res[1] for res in result]

def fake_extract_ohlc(image):
    # Ø¨ÙŠØ§Ù†Ø§Øª OHLC ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€” Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨ØªØ­Ù„ÙŠÙ„ ÙØ¹Ù„ÙŠ Ø¹Ø¨Ø± OpenCV
    return pd.DataFrame({
        "open": [0.000279, 0.000272, 0.000264],
        "high": [0.000281, 0.000274, 0.000266],
        "low":  [0.000265, 0.000258, 0.000252],
        "close":[0.000270, 0.000260, 0.000255],
        "volume": [3200000000, 2900000000, 3100000000]
    })

def analyze(df):
    df['ema'] = ta.trend.EMAIndicator(df['close'], window=3).ema_indicator()
    df['rsi'] = ta.momentum.RSIIndicator(df['close'], window=3).rsi()
    macd = ta.trend.MACD(df['close'])
    df['macd'] = macd.macd()
    df['macd_signal'] = macd.macd_signal()
    df['kdj'] = (df['high'] + df['low'] + df['close']) / 3  # Ù…Ø¤Ø´Ø± Ù…Ø®ØµØµ Ù…Ø¨Ø³Ø·
    return df.dropna()

def predict_next_candle(df):
    last = df.iloc[-1]
    if last['rsi'] < 30 and last['macd'] > last['macd_signal']:
        return "ğŸ”® Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ØµØ¹ÙˆØ¯ Ù…Ø­ØªÙ…Ù„"
    elif last['rsi'] > 70 and last['macd'] < last['macd_signal']:
        return "ğŸ”® Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: Ù‡Ø¨ÙˆØ· Ù…Ø­ØªÙ…Ù„"
    else:
        return "ğŸ”® Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ØªØ°Ø¨Ø°Ø¨ / ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©"

def recommendation(df):
    last = df.iloc[-1]
    if last['rsi'] < 30 and last['macd'] > last['macd_signal']:
        return "âœ… Ø´Ø±Ø§Ø¡", "ØªØ´Ø¨Ø¹ Ø¨ÙŠØ¹ÙŠ + ØªÙ‚Ø§Ø·Ø¹ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ"
    elif last['rsi'] > 70 and last['macd'] < last['macd_signal']:
        return "âŒ Ø¨ÙŠØ¹", "ØªØ´Ø¨Ø¹ Ø´Ø±Ø§Ø¦ÙŠ + ØªÙ‚Ø§Ø·Ø¹ Ø³Ù„Ø¨ÙŠ"
    else:
        return "ğŸ” Ø­ÙŠØ§Ø¯", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© Ù…Ø¤ÙƒØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"

def trade_levels(df, rr_ratio=2.0):
    entry = df['close'].iloc[-1]
    sl = df['low'].min() * 0.98
    tp = entry + (entry - sl) * rr_ratio
    rr = (tp - entry) / (entry - sl)
    return entry, sl, tp, rr

if uploaded_file:
    image = Image.open(uploaded_file).convert("RGB")
    st.image(image, caption="ğŸ“· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©", use_column_width=True)

    st.subheader("ğŸ§  Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©:")
    text_lines = extract_text_from_image(image)
    st.code("\\n".join(text_lines))

    st.subheader("ğŸ“¥ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ OHLC:")
    df = fake_extract_ohlc(image)
    st.dataframe(df)

    st.subheader("ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ:")
    df = analyze(df)
    signal, reason = recommendation(df)
    entry, sl, tp, rr = trade_levels(df)

    st.success(f"ğŸ“Œ Ø§Ù„ØªÙˆØµÙŠØ©: {signal}")
    st.info(f"ğŸ“Œ Ø§Ù„Ø³Ø¨Ø¨: {reason}")
    st.markdown(f"- ğŸ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„: `{entry:.8f}`")
    st.markdown(f"- âŒ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: `{sl:.8f}`")
    st.markdown(f"- âœ… Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: `{tp:.8f}`")
    st.markdown(f"- ğŸ“ˆ Ù†Ø³Ø¨Ø© R/R: `{rr:.2f}`")

    st.subheader("ğŸ“‰ Ø§Ù„ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ:")
    st.warning(predict_next_candle(df))

    fig, ax = plt.subplots()
    ax.plot(df['close'], label='Ø§Ù„Ø³Ø¹Ø±')
    ax.plot(df['ema'], label='EMA')
    ax.set_title("ğŸ“ˆ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ")
    ax.legend()
    st.pyplot(fig)
    import pandas as pd
import matplotlib.pyplot as plt
import ta

# 1. Ø¨ÙŠØ§Ù†Ø§Øª OHLC Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø´Ù…ÙˆØ¹ 4 Ø³Ø§Ø¹Ø§Øª) â† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
data = {
    "open": [100, 102, 104, 103, 105, 106, 108, 107],
    "high": [103, 105, 106, 105, 107, 109, 110, 109],
    "low":  [98, 100, 101, 102, 104, 105, 106, 106],
    "close":[101, 104, 105, 104, 106, 108, 107, 108],
    "volume": [1500, 1800, 1700, 1600, 2000, 2100, 2200, 2300]
}
df = pd.DataFrame(data)

# 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©
df['ema'] = ta.trend.EMAIndicator(df['close'], window=3).ema_indicator()
df['rsi'] = ta.momentum.RSIIndicator(df['close'], window=3).rsi()
macd = ta.trend.MACD(df['close'])
df['macd'] = macd.macd()
df['macd_signal'] = macd.macd_signal()
df = df.dropna()

# 3. ØªÙˆÙ‚Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³ÙˆÙ‚
def forecast_direction(df):
    last = df.iloc[-1]
    if last['rsi'] < 30 and last['macd'] > last['macd_signal'] and last['close'] > last['ema']:
        return "up"
    elif last['rsi'] > 70 and last['macd'] < last['macd_signal'] and last['close'] < last['ema']:
        return "down"
    else:
        return "side"

direction = forecast_direction(df)

# 4. ØªÙˆÙ„ÙŠØ¯ 3 Ø´Ù…ÙˆØ¹ Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
def generate_future_candles(df, direction, count=3):
    last_close = df['close'].iloc[-1]
    candles = []
    for i in range(count):
        if direction == "up":
            open_price = last_close * (1 + 0.005)
            close_price = open_price * (1 + 0.005)
        elif direction == "down":
            open_price = last_close * (1 - 0.005)
            close_price = open_price * (1 - 0.005)
        else:  # side
            open_price = last_close
            close_price = last_close

        high = max(open_price, close_price) * 1.002
        low = min(open_price, close_price) * 0.998
        volume = df['volume'].mean()
        candles.append({
            "open": open_price,
            "high": high,
            "low": low,
            "close": close_price,
            "volume": volume
        })
        last_close = close_price
    return pd.DataFrame(candles)

future_df = generate_future_candles(df, direction)

# 5. Ø¯Ù…Ø¬ Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© + Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
combined = pd.concat([df[['open', 'high', 'low', 'close']], future_df], ignore_index=True)

# 6. Ø±Ø³Ù… Ø§Ù„Ø´Ù…ÙˆØ¹ (Ø´ÙƒÙ„ Ø®Ø·ÙŠ Ù…Ø¨Ø³Ø·)
plt.figure(figsize=(10, 5))
plt.plot(combined['close'], marker='o', label='Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹')
plt.axvline(x=len(df)-1, color='gray', linestyle='--', label='Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©')
plt.title("ğŸ“ˆ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù…Ø¹ ØªÙˆÙ‚Ø¹ Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©")
plt.xlabel("Ø§Ù„Ø´Ù…ÙˆØ¹")
plt.ylabel("Ø§Ù„Ø³Ø¹Ø±")
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()